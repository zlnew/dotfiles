#!/usr/bin/env bash
set -euo pipefail

CONFIG_FILE="/etc/battery-limit.conf"
SYSFS_PATH="/sys/class/power_supply/BAT0/charge_control_end_threshold"

SUDO_cmd() {
  if [[ $EUID -eq 0 ]]; then
    "$@"
  else
    sudo "$@"
  fi
}

usage() {
  echo "Usage:"
  echo "  $0 set <60|80|100>   Set battery charge limit"
  echo "  $0 get               Show current battery charge limit"
  exit 1
}

cmd_set() {
  local LIMIT=$1

  if [[ "$LIMIT" != "60" && "$LIMIT" != "80" && "$LIMIT" != "100" ]]; then
    echo "Error: Invalid limit. Please use 60, 80, or 100."
    exit 1
  fi

  # Update config
  SUDO_cmd tee "$CONFIG_FILE" > /dev/null <<EOF
BATTERY_LIMIT=$LIMIT
EOF

  # Apply to sysfs
  echo "$LIMIT" | SUDO_cmd tee "$SYSFS_PATH" > /dev/null

  echo "âœ… Battery limit set to $LIMIT%"
}

cmd_get() {
  if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
    echo "Config file limit: ${BATTERY_LIMIT:-unknown}%"
  else
    echo "Config file not found."
  fi

  if [[ -f "$SYSFS_PATH" ]]; then
    echo -n "Kernel current limit: "
    cat "$SYSFS_PATH"
  else
    echo "Sysfs path not found."
  fi
}

main() {
  [[ $# -lt 1 ]] && usage

  case $1 in
    set)
      [[ $# -ne 2 ]] && usage
      cmd_set "$2"
      ;;
    get)
      cmd_get
      ;;
    *)
      usage
      ;;
  esac
}

main "$@"
