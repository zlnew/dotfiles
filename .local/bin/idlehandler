#!/usr/bin/env bash

set -euo pipefail

pkill -x swayidle || true

# ─────────────────────────────────────────────
# Mode selector
# ─────────────────────────────────────────────
TEST_MODE=false

if [[ "${1:-}" == "--test" ]]; then
    TEST_MODE=true
fi

if $TEST_MODE; then
    echo "⚙️  Running in TEST MODE (fast timeouts)"
    LOCK_TIME=10
    WARN_TIME=19
    SUSPEND_TIME=29
else
    LOCK_TIME=900     # 15 min
    WARN_TIME=1790    # 29m 50s
    SUSPEND_TIME=1800 # 30 min
fi

# ─────────────────────────────────────────────
# Define lock command
# ─────────────────────────────────────────────
LOCK_CMD="swaylock-fancy -p -g"

# ─────────────────────────────────────────────
# Run swayidle
# ─────────────────────────────────────────────
swayidle -w \
    timeout "$LOCK_TIME" "$LOCK_CMD &" \
    timeout "$WARN_TIME" 'notify-send "💤 Suspending in 10s..."' \
    timeout "$SUSPEND_TIME" 'systemctl suspend' \
    before-sleep "$LOCK_CMD & disown"

